/*
parametr[1]  HOUR
parametr[1]  MIN
parametr[2]  TEMP
parametr[3]  LEAK
parametr[4]  LIGHT
parametr[5]  BOBBER1
parametr[6]  BOBBER2
parametr[7]  BOBBER3
parametr[8]  BOBBER4
parametr[9]  SWITCH1
parametr[10]  SWITCH2
parametr[11]  SWITCH3
parametr[12]  SWITCH4
parametr[13]  OBTACLE1
parametr[14]  OBTACLE2
parametr[15]  STEP1_STATE
parametr[16]  STEP2_STATE
parametr[17]  STEP3_STATE
parametr[18]  STEP4_STATE


parametr[19]  SOLI
parametr[20]  LASER1
parametr[21]  LASER2
parametr[22]  VALVE1
parametr[23]  VALVE2
parametr[24]  VALVE3
parametr[25]  VALVE4
parametr[26]  VALVE5
parametr[27]  VALVE6
parametr[28]  PUMP1
parametr[29]  PUMP2
parametr[30]  PUMP3
parametr[31]  PUMP4
parametr[32]  BIG_PUMP
parametr[33]  DEVICE1
parametr[34]  DEVICE2
parametr[35]  DEVICE3
parametr[36]  DEVICE4
parametr[37]  DEVICE5
parametr[38]  DEVICE6
parametr[39]  DEVICE7
parametr[40]  DEVICE8
parametr[41]  DRIVE1
parametr[42]  DRIVE2
parametr[43]  DRIVE3
parametr[44]  DRIVE4
parametr[45]  LED


parametr[46]  STEP3_hour_on
parametr[47]  STEP3_min_on
parametr[48]  STEP3_hour_off
parametr[49]  STEP3_min_off
parametr[50]  STEP4_hour_on
parametr[51]  STEP4_min_on
parametr[52]  STEP4_hour_off
parametr[53]  STEP4_min_off
parametr[54]  SOLI_hour_on
parametr[55]  SOLI_min_on
parametr[56]  SOLI_hour_off
parametr[57]  SOLI_min_off
parametr[58]  LASER1_hour_on
parametr[59]  LASER1_min_on
parametr[60]  LASER1_hour_off
parametr[61]  LASER1_min_off
parametr[62]  LASER2_hour_on
parametr[63]  LASER2_min_on
parametr[64]  LASER2_hour_off
parametr[65]  LASER2_min_off
parametr[66]  VALVE1_hour_on
parametr[67]  VALVE1_min_on
parametr[68]  VALVE1_hour_off
parametr[69]  VALVE1_min_off
parametr[70]  VALVE2_hour_on
parametr[71]  VALVE2_min_on
parametr[72]  VALVE2_hour_off
parametr[73]  VALVE2_min_off
parametr[74]  VALVE3_hour_on
parametr[75]  VALVE3_min_on
parametr[76]  VALVE3_hour_off
parametr[77]  VALVE3_min_off
parametr[78]  VALVE4_hour_on
parametr[79]  VALVE4_min_on
parametr[80]  VALVE4_hour_off
parametr[81]  VALVE4_min_off
parametr[82]  VALVE5_hour_on
parametr[83]  VALVE5_min_on
parametr[84]  VALVE5_hour_off
parametr[85]  VALVE5_min_off
parametr[86]  VALVE6_hour_on
parametr[87]  VALVE6_min_on
parametr[88]  VALVE6_hour_off
parametr[89]  VALVE6_min_off
parametr[90]  PUMP1_hour_on
parametr[91]  PUMP1_min_on
parametr[92]  PUMP1_hour_off
parametr[93]  PUMP1_min_off
parametr[94]  PUMP2_hour_on
parametr[95]  PUMP2_min_on
parametr[96]  PUMP2_hour_off
parametr[97]  PUMP2_min_off
parametr[98]  PUMP3_hour_on
parametr[99]  PUMP3_min_on
parametr[100]  PUMP3_hour_off
parametr[101]  PUMP3_min_off
parametr[102]  PUMP4_hour_on
parametr[103]  PUMP4_min_on
parametr[104]  PUMP4_hour_off
parametr[105]  PUMP4_min_off
parametr[106]  BIG_PUMP_hour_on
parametr[107]  BIG_PUMP_min_on
parametr[108]  BIG_PUMP_hour_off
parametr[109]  BIG_PUMP_min_off
parametr[110]  DEVICE1_hour_on
parametr[111]  DEVICE1_min_on
parametr[112]  DEVICE1_hour_off
parametr[113]  DEVICE1_min_off
parametr[114]  DEVICE2_hour_on
parametr[115]  DEVICE2_min_on
parametr[116]  DEVICE2_hour_off
parametr[117]  DEVICE2_min_off
parametr[118]  DEVICE3_hour_on
parametr[119]  DEVICE3_min_on
parametr[120]  DEVICE3_hour_off
parametr[121]  DEVICE3_min_off
parametr[122]  DEVICE4_hour_on
parametr[123]  DEVICE4_min_on
parametr[124]  DEVICE4_hour_off
parametr[125]  DEVICE4_min_off
parametr[126]  DEVICE5_hour_on
parametr[127]  DEVICE5_min_on
parametr[128]  DEVICE5_hour_off
parametr[129]  DEVICE5_min_off
parametr[130]  DEVICE6_hour_on
parametr[131]  DEVICE6_min_on
parametr[132]  DEVICE6_hour_off
parametr[133]  DEVICE6_min_off
parametr[134]  DEVICE7_hour_on
parametr[135]  DEVICE7_min_on
parametr[136]  DEVICE7_hour_off
parametr[137]  DEVICE7_min_off
parametr[138]  DEVICE8_hour_on
parametr[139]  DEVICE8_min_on
parametr[140]  DEVICE8_hour_off
parametr[141]  DEVICE8_min_off
parametr[142]  LED_hour_on
parametr[143]  LED_min_on
parametr[144]  LED_hour_off
parametr[145]  LED_min_off
parametr[146]  DRIVE1_hour_on
parametr[147]  DRIVE1_min_on
parametr[148]  DRIVE1_hour_off
parametr[149]  DRIVE1_min_off
parametr[150]  DRIVE2_hour_on
parametr[151]  DRIVE2_min_on
parametr[152]  DRIVE2_hour_off
parametr[153]  DRIVE2_min_off
parametr[154]  DRIVE3_hour_on
parametr[155]  DRIVE3_min_on
parametr[156]  DRIVE3_hour_off
parametr[157]  DRIVE3_min_off
parametr[158]  DRIVE4_hour_on
parametr[159]  DRIVE4_min_on
parametr[160]  DRIVE4_hour_off
parametr[161]  DRIVE4_min_off
parametr[162]  STEP1_hour_on
parametr[163]  STEP1_min_on
parametr[164]  STEP1_hour_off
parametr[165]  STEP1_min_off
parametr[166]  STEP2_hour_on
parametr[167]  STEP2_min_on
parametr[168]  STEP2_hour_off
parametr[169]  STEP2_min_off

parametr[170]  StartMonthIrrigation
parametr[171]  StartDayIrrigation
parametr[172]  StartHourIrrigation
parametr[173]  StartMinIrrigation
parametr[174]  IrrigationCycle
parametr[175]  IrrigationMix
parametr[176]  IrrigationDuration
parametr[177]  TankFlagIrrigation
parametr[178]  CycleDayIrrigation
parametr[179]  CycleHourIrrigation

parametr[180]  StartMonthWaterring
parametr[181]  StartDayWaterring
parametr[182]  StartHourWaterring
parametr[183]  StartMinWaterring
parametr[184]  WateringCycle
parametr[185]  WateringMix
parametr[186]  WateringDuration
parametr[187]  TankFlagWatering
parametr[188]  CycleDayWatering
parametr[189]  CycleHourWatering

parametr[190]  led_pattern_hour_On
parametr[191]  led_pattern_min_On
parametr[192]  led_pattern_hour_Off
parametr[193]  led_pattern_min_Off

parametr[194]  STEP1_value
parametr[195]  STEP2_value
parametr[196]  STEP3_value
parametr[197]  STEP4_value
parametr[198]  key
*/

#include <Arduino.h>
#include <SPI.h>
#include <Wire.h>

// если произошло событие на сайте  Internet_flag будет равен 1
int Internet_flag = 0;
// адрес меги
#define SLAVE_ADDR 7
// Если на этом пине 1, меха хочет передать данные
const int SlavePin = A0; // d7
// флаг для приема данных
int CurrentGetFlag = 0;
int PreviousGetFlag = 0;

// количество хранимых переменных
const int leng = 199;
// текущее значение переменных
int CurrentSensorState[leng];
// предыдущее значение
int PreviousSensorState[leng];
// буфер для i2c передачи
int buffer[leng];
// буфер для получения данных с интернета
int InternetSensorState[leng];
int inter[leng];
// флаг сигнализирующий о первой передаче
bool FirstTimeFlag = 1;

unsigned long TimeOfAsking;
// сщетчик байтов и байт для i2c передачи
int bcount;
byte bval;
// настройка работы с сервером
#include <WiFiAdjust.h>
// переменная для хранения IP адреса
String adr;

// функция получения данных от меги
byte readI2C(int address)
{
    // Define a variable to hold byte of data
    byte bval;
    long entry = millis();
    // Read one byte at a time
    Wire.requestFrom(address, 1);
    // Wait 100 ms for data to stabilize
    while (Wire.available() == 0 && (millis() - entry) < 100)
        ;
    ;
    // Place data into byte
    if (millis() - entry < 100)
        bval = Wire.read();
    return bval;
}

// функция отправки данных в Мегу первый раз

void FirstTimeSendData()
{
    Serial.println("Send data first time");
    adr = WiFi.localIP().toString();
    //передача IP адреса при включении
    for (int i = 0; i < adr.length(); i++)
    {
        Wire.beginTransmission(SLAVE_ADDR);
        bval = adr[i];
        Wire.write(bval);
        Wire.endTransmission();
        Serial.print(adr[i]);
    }
    Serial.println();
    Wire.beginTransmission(SLAVE_ADDR);
    CurrentSensorState[leng - 1] = 254;
    Wire.write(CurrentSensorState[leng - 1]);
    Wire.endTransmission();
    // Адррес передали
    // передачаненулевых данных
    byte bval;
    bval = 255; // send key-start
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write(bval);
    Wire.endTransmission();
    delay(10);
    for (int i = 0; i < leng - 2; i++)
    {
        if (CurrentSensorState[i] != 0)
        {
            bval = i;
            Wire.beginTransmission(SLAVE_ADDR);
            Wire.write(bval);
            Wire.endTransmission();
            bval = CurrentSensorState[i];
            Wire.beginTransmission(SLAVE_ADDR);
            Wire.write(bval);
            Wire.endTransmission();
            Serial.print(i);
            Serial.print("/");
            Serial.print(CurrentSensorState[i]);
            Serial.print("  ");
            delay(10);
        }
    }
    Serial.println();
    Wire.beginTransmission(SLAVE_ADDR);
    CurrentSensorState[leng - 1] = 254;
    Wire.write(CurrentSensorState[leng - 1]);
    Wire.endTransmission();
    Serial.println("I sendED data first time");
}
void setup()
{
    Serial.begin(115200);
    /*for (int i = 0; i < leng; i++)
  {
    Serial.print("parametr[");
    Serial.print(i);
    Serial.print("]  ");
    Serial.println(parametr[i]);
  }
  */
    //установка пина для того чтобы слушать мегу
    WiFiSetup();
    /* задаем i2c мост через контакты SDA=D1 и SCL=D2 на NodeMCU */
    Wire.begin(D1, D2);
    // записываем IP адрес
    Serial.println("wait before send first data");
    Serial.println("fun begin");
    FirstTimeSendData();
}
int k;
unsigned long tiki = 0;
bool sdlog;
void loop()
{
    // CurrentGetFlag = 1;
    if ((millis() - tiki) > 200)
    {
        tiki = millis();
        PreviousGetFlag = CurrentGetFlag;
        CurrentGetFlag = analogRead(A0);
        if (CurrentGetFlag > 600)
        {
            Serial.println("HIGH");
        }
        //else
        // Serial.print("I here");
    }
    /*
  // слушаем мегу
  // если мега хочет нам что то сказать, при этом в сети тихо, то слушаем мегу
 */
    //
    //CurrentGetFlag = 1;

    if (CurrentGetFlag > 600 && (PreviousGetFlag < 600) && !Internet_flag)
    {
        // начинаем принимать данные
        Serial.println("I get date from MEGA");

        while (readI2C(SLAVE_ADDR) < 255)
        {
            // Until first byte has been received print a waiting message
            Serial.print("Waiting");
        }
        bcount = 0;
        // принимать данные пока не наталкнемся на ключ
        while (buffer[bcount - 1] != 254)
        {
            // записываем данные в буфер
            buffer[bcount] = readI2C(SLAVE_ADDR);
            bcount++;
        }
        // обновляем текущие данные
        if (buffer[0] != 255)
        {
            for (int i = 0; i < bcount - 1; i = i + 2)
            {
                CurrentSensorState[buffer[i]] = buffer[i + 1];
                Serial.print(buffer[i]);
                Serial.print("/");
                Serial.print(CurrentSensorState[buffer[i]]);
                Serial.print(" ");
            }
        }
        else
        {
            for (int i = 1; i < bcount - 1; i = i + 2)
            {
                CurrentSensorState[buffer[i]] = buffer[i + 1];
                Serial.print(buffer[i]);
                Serial.print("/");
                Serial.print(CurrentSensorState[buffer[i]]);
                Serial.print(" ");
            }
        }
        Serial.println(" ");
        for (int i = 0; i < leng; i++)
        {
            //переопределяем и публикуем только новые данные
            if (CurrentSensorState[i] != PreviousSensorState[i] && i != 174 && i != 184 && i != 178 && i != 179 && i != 188 && i != 189)
            {
                PreviousSensorState[i] = CurrentSensorState[i];
                SendingValueToString(i, CurrentSensorState[i]);
                events.send(String(CurrentSensorState[i]).c_str(), parametr[i], millis());
                if (i != 1)
                    sdlog = 1;
            }
            if (CurrentSensorState[i] != PreviousSensorState[i] && (i == 178 || i == 188))
            {
                PreviousSensorState[i] = CurrentSensorState[i];
                SendingValueToString(i, CurrentSensorState[i]);
                CurrentSensorState[i - 4] = CurrentSensorState[i] * 24;
                events.send(String(CurrentSensorState[i] * 24).c_str(), parametr[i - 4], millis());
            }
            else if (CurrentSensorState[i] != PreviousSensorState[i] && (i == 179 || i == 189))
            {
                PreviousSensorState[i] = CurrentSensorState[i];
                SendingValueToString(i, CurrentSensorState[i]);
                CurrentSensorState[i - 5] += CurrentSensorState[i];
                events.send(String(CurrentSensorState[i - 1] * 24 + CurrentSensorState[i]).c_str(), parametr[i - 5], millis());
            }
        }
        // сохраняем все
        //writeFile(LittleFS, MyFile, GeneralString);
        writeFile("datalog.txt", GeneralString);

        // сбрасываю флаг
        Serial.println("The date was recived");
        PreviousGetFlag = CurrentGetFlag;
    }

    // Если в интернете что то произошло
    if (Internet_flag)
    {
        Serial.println("Something has happend in internet");
        // сохраняем данные
        //writeFile(LittleFS, MyFile, GeneralString);
        writeFile("datalog.txt", GeneralString);
        // отправляем данные меге
        byte bval;
        bval = 255; // send key-start
        Wire.beginTransmission(SLAVE_ADDR);
        Wire.write(bval);
        Wire.endTransmission();
        for (int i = 14; i < leng; i++)
        {
            if (InternetSensorState[i] != CurrentSensorState[i] && inter[i] != 0 && i != 174 && i != 184)
            {
                Serial.print(i);
                Serial.print("_");
                Serial.print(InternetSensorState[i]);
                Serial.print(" ");
                CurrentSensorState[i] = InternetSensorState[i];
                bval = i;
                Wire.beginTransmission(SLAVE_ADDR);
                Wire.write(bval);
                Wire.endTransmission();
                bval = CurrentSensorState[i];
                Wire.beginTransmission(SLAVE_ADDR);
                Wire.write(bval);
                Wire.endTransmission();
                inter[i] = 0;
            }
        }
        Wire.beginTransmission(SLAVE_ADDR);
        CurrentSensorState[leng - 1] = 254;
        Wire.write(CurrentSensorState[leng - 1]);
        Wire.endTransmission();

        // обнуляем флаги
        Internet_flag = 0;
        FirstTimeFlag = 0;
        Serial.println("I sended date from Inet");
    }
}
